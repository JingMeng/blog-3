# 数据库设计的一些原则

根据现在项目的情况，之后肯定会使用sqlite作为本地数据库。

这里记录一些sqlite相关的比较好的文章或者原理

* [sqlite原理](http://huili.github.io/)
* [微信iOS SQLite源码优化实践](https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649286361&idx=1&sn=78bbcda7f41a14291ad71289e4821f71&scene=4#wechat_redirect)
* [关系型数据库原理](http://blog.jobbole.com/100349/)
* [腾讯云开发者手册](https://cloud.tencent.com/developer/doc/1228)

## 存储

使用递增的整数型自增主键虽然会在性能或者可迁移性上有良好的效果，不过在实际的使用上会出现需要查询非主键的情况。在这种情况下的查询效率其实不是特别好。所以一般情况下采用自定义的自增主键或者通过对数据进行位运算之类的方式做出主键可能是一种较好的方式。

不建议使用业务相关的数据作为主键，因为业务是有可能随时进行调整的，如果按照业务的数据作为主键，免不了之后会对数据库的主键进行调整。每次调整主键都会导致一系列的数据发生变动，非常影响数据库的性能。

不允许对主键进行变更操作。若变更主键，有可能会导致整棵树都发生变动，效率太差。而且若主键还是其他表的外键，还会导致需要维护其他表的数据，得不偿失。

若需要删除某条数据，最好的方式是先在记录的某个位置打个标记，表示该数据已废弃，等某个时间进行统一的删除处理。原因同上。

## 查询

查询主键肯定比查询非主键要快，那么就意味着如果可以的话，尽量避免对非主键进行查询的操作。

不可避免的，我们需要对非主键进行查询，那么就把常用的非主键查询建立索引。这样会提升非主键查询的效率。但是又引入了一个问题，插入的时候会导致索引和列表同时插入数据，会增加插入和更新操作时候的时间。

也许我们可以通过将数据预先加载到内存中并建立映射关系的方式来处理，这样会提高查询速度。

## 全文搜索 fts

fts是sqlite给出的全文搜索解决方案。fts的本质是利用分词器，将字段拆分成各种索引表，使用虚表进行统一管理。也就是说，sqlite中的虚表并不是现实存在的，而是一种类似于管理器的东西。通过对虚表所属的索引等进行查询，从而加快全文搜索的速度。但是这个虚表管理了大量的索引，导致的结果就是插入和删除数据特别慢。所以在sqlite的官方文档上都建议一批一批的进行操作，而且建议做异步的操作。

## 替换方案

realm这种非关系型数据库可能是以后的一种开发方案。看上去这个东西不需要做序列化或者反序列化的东西，而是通过文件映射的方式直接读取到内存里面，这样就不需要复杂的语义分析等等。当然这种方式会是比较具有毁灭性的，会影响到整个数据的设计和思维方式的转变，所以要么就一开始就使用，要么就先别想这个玩意了。

非常悲剧的是 这个东西是没有c++ API的，虽然底层是c++写的。也就是说，除了像Qt这种自带js引擎的，基于其他开发的话估计是不能使用realm的。

发现google的levelDb有c++的接口，而且支持全文查询，也许是一种替代方案？

[LevelDB架构与原理](http://johng.cn/leveldb-intro/)